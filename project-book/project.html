<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>踩坑记录 | 日常所得</title>
    <meta name="description" content="一个前端的个人站点">
    <link rel="icon" href="/book/icon.png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.slim.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.css">
    
    <link rel="preload" href="/book/assets/css/0.styles.64259fb2.css" as="style"><link rel="preload" href="/book/assets/js/app.983c8796.js" as="script"><link rel="preload" href="/book/assets/js/29.e1cc56d4.js" as="script"><link rel="prefetch" href="/book/assets/js/10.da845a38.js"><link rel="prefetch" href="/book/assets/js/11.1caf8d01.js"><link rel="prefetch" href="/book/assets/js/12.c601ecec.js"><link rel="prefetch" href="/book/assets/js/13.cf176923.js"><link rel="prefetch" href="/book/assets/js/14.c779bb5e.js"><link rel="prefetch" href="/book/assets/js/15.287a2825.js"><link rel="prefetch" href="/book/assets/js/16.06b9e1a0.js"><link rel="prefetch" href="/book/assets/js/17.24ed438e.js"><link rel="prefetch" href="/book/assets/js/18.e84357ba.js"><link rel="prefetch" href="/book/assets/js/19.3c920a8e.js"><link rel="prefetch" href="/book/assets/js/2.5deeb130.js"><link rel="prefetch" href="/book/assets/js/20.ad25a40f.js"><link rel="prefetch" href="/book/assets/js/21.9163c470.js"><link rel="prefetch" href="/book/assets/js/22.d3ef709f.js"><link rel="prefetch" href="/book/assets/js/23.7f36020e.js"><link rel="prefetch" href="/book/assets/js/24.bcef834f.js"><link rel="prefetch" href="/book/assets/js/25.b086ad25.js"><link rel="prefetch" href="/book/assets/js/26.67a7ab5e.js"><link rel="prefetch" href="/book/assets/js/27.79025d64.js"><link rel="prefetch" href="/book/assets/js/28.d79d5460.js"><link rel="prefetch" href="/book/assets/js/3.76a65929.js"><link rel="prefetch" href="/book/assets/js/30.92772f1e.js"><link rel="prefetch" href="/book/assets/js/31.d02288e7.js"><link rel="prefetch" href="/book/assets/js/4.b836e44f.js"><link rel="prefetch" href="/book/assets/js/5.1742c36e.js"><link rel="prefetch" href="/book/assets/js/6.ecf6eae9.js"><link rel="prefetch" href="/book/assets/js/7.4e04405a.js"><link rel="prefetch" href="/book/assets/js/8.69802f27.js"><link rel="prefetch" href="/book/assets/js/9.95d028bc.js">
    <link rel="stylesheet" href="/book/assets/css/0.styles.64259fb2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/book/" class="home-link router-link-active"><!----> <span class="site-name">日常所得</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/book/front-docs/" class="nav-link">前端</a></div><div class="nav-item"><a href="/book/project-book/" class="nav-link router-link-active">踩坑记录</a></div><div class="nav-item"><a href="/book/linux/" class="nav-link">linux</a></div><div class="nav-item"><a href="/book/front-build/" class="nav-link">前端构建</a></div> <a href="https://github.com/hkx930919/book" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/book/front-docs/" class="nav-link">前端</a></div><div class="nav-item"><a href="/book/project-book/" class="nav-link router-link-active">踩坑记录</a></div><div class="nav-item"><a href="/book/linux/" class="nav-link">linux</a></div><div class="nav-item"><a href="/book/front-build/" class="nav-link">前端构建</a></div> <a href="https://github.com/hkx930919/book" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/book/project-book/" class="sidebar-link">踩坑</a></li><li><a href="/book/project-book/project.html" class="active sidebar-link">踩坑记录</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/book/project-book/project.html#_1-h5-页面适配-iphonex" class="sidebar-link">1. H5 页面适配 IPHONEX</a></li><li class="sidebar-sub-header"><a href="/book/project-book/project.html#_2-苹果微信浏览器滑动，出现网站标识" class="sidebar-link">2. 苹果微信浏览器滑动，出现网站标识</a></li><li class="sidebar-sub-header"><a href="/book/project-book/project.html#_3-video-标签在移动端的坑" class="sidebar-link">3. video 标签在移动端的坑</a></li><li class="sidebar-sub-header"><a href="/book/project-book/project.html#_4-fastclick-在部分-ios-引起的问题" class="sidebar-link">4 fastclick 在部分 ios 引起的问题</a></li><li class="sidebar-sub-header"><a href="/book/project-book/project.html#_5-浏览器打印" class="sidebar-link">5 浏览器打印</a></li></ul></li></ul> </div> <div class="page"> <div class="content"><h1 id="踩坑记录"><a href="#踩坑记录" aria-hidden="true" class="header-anchor">#</a> 踩坑记录</h1> <h2 id="_1-h5-页面适配-iphonex"><a href="#_1-h5-页面适配-iphonex" aria-hidden="true" class="header-anchor">#</a> 1. H5 页面适配 IPHONEX</h2> <blockquote><p>iphonex 取消了物理按键，改成底部小黑条。
ios11 新增特性，苹果公司为了适配 iPhoneX 对现有 viewport meta 标签的一个扩展,</p></blockquote> <ul><li>contain: 可视窗口完全包含网页内容（左图）</li> <li>cover：网页内容完全覆盖可视窗口（右图）</li> <li>auto：默认值，跟 contain 表现一致</li></ul> <blockquote><p>需要适配 iPhoneX 必须设置 viewport-fit=cover，这是适配的关键步骤。</p></blockquote> <h3 id="env-和-constant"><a href="#env-和-constant" aria-hidden="true" class="header-anchor">#</a> env() 和 constant()</h3> <p>iOS11 新增特性，Webkit 的一个 CSS 函数，用于设定安全区域与边界的距离，有四个预定义的变量：</p> <ul><li>safe-area-inset-left：安全区域距离左边边界距离</li> <li>safe-area-inset-right：安全区域距离右边边界距离</li> <li>safe-area-inset-top：安全区域距离顶部边界距离</li> <li>safe-area-inset-bottom：安全区域距离底部边界距离</li></ul> <blockquote><p>适配底部 fixed 元素的 tabbar 时，使用 safe-area-inset-bottom 这个变量，因为它对应的就是小黑条的高度 <br> &gt; <em>注意：当 viewport-fit=contain 时 env() 是不起作用的，必须要配合 viewport-fit=cover 使用。对于不支持 env() 的浏览器，浏览器将会忽略它。</em></p></blockquote> <div class="language-css line-numbers-mode"><pre class="language-css"><code><span class="token property">padding-bottom</span><span class="token punctuation">:</span> <span class="token function">constant</span><span class="token punctuation">(</span>
  safe-area-inset-bottom
<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 兼容 iOS &lt; 11.2 */</span> <span class="token comment">/*constant() 在 iOS11.2 之后就不能使用的*/</span>
<span class="token property">padding-bottom</span><span class="token punctuation">:</span> <span class="token function">env</span><span class="token punctuation">(</span>safe-area-inset-bottom<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 兼容 iOS &gt;= 11.2 */</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="适配开始"><a href="#适配开始" aria-hidden="true" class="header-anchor">#</a> 适配开始</h3> <ul><li>1 设置 viewport</li></ul> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span>
  <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no,viewport-fit=cover<span class="token punctuation">&quot;</span></span>
<span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>2 使用@supports 隔离兼容样式 如果我们只希望 iPhoneX 才需要新增适配样式，我们可以配合 @supports 来隔离兼容样式</li></ul> <div class="language-css line-numbers-mode"><pre class="language-css"><code><span class="token atrule"><span class="token rule">@supports</span> <span class="token punctuation">(</span><span class="token property">bottom</span><span class="token punctuation">:</span> <span class="token function">constant</span><span class="token punctuation">(</span>safe-area-inset-bottom<span class="token punctuation">)</span><span class="token punctuation">)</span> or
  <span class="token punctuation">(</span><span class="token property">bottom</span><span class="token punctuation">:</span> <span class="token function">env</span><span class="token punctuation">(</span>safe-area-inset-bottom<span class="token punctuation">)</span><span class="token punctuation">)</span></span> <span class="token punctuation">{</span>
  <span class="token selector">div</span> <span class="token punctuation">{</span>
    <span class="token property">margin-bottom</span><span class="token punctuation">:</span> <span class="token function">constant</span><span class="token punctuation">(</span>safe-area-inset-bottom<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token property">margin-bottom</span><span class="token punctuation">:</span> <span class="token function">env</span><span class="token punctuation">(</span>safe-area-inset-bottom<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li>3 页面主体内容限定在安全区域内</li></ul> <div class="language-css line-numbers-mode"><pre class="language-css"><code><span class="token selector">body</span> <span class="token punctuation">{</span>
  <span class="token property">padding-bottom</span><span class="token punctuation">:</span> <span class="token function">constant</span><span class="token punctuation">(</span>safe-area-inset-bottom<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token property">padding-bottom</span><span class="token punctuation">:</span> <span class="token function">env</span><span class="token punctuation">(</span>safe-area-inset-bottom<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>4 适配 fixed 吸底元素
<blockquote><p>1 使用 margin-bottom 或者 padding-bottom <br>
2 通过 calc 扩展元素高度</p></blockquote></li></ul> <div class="language-css line-numbers-mode"><pre class="language-css"><code><span class="token comment">/* 1 更改padding-bottom*/</span>
 <span class="token punctuation">{</span>
  <span class="token property">padding-bottom</span><span class="token punctuation">:</span> <span class="token function">constant</span><span class="token punctuation">(</span>safe-area-inset-bottom<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token property">padding-bottom</span><span class="token punctuation">:</span> <span class="token function">env</span><span class="token punctuation">(</span>safe-area-inset-bottom<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 2 覆盖高度*/</span>
 <span class="token punctuation">{</span>
  <span class="token property">height</span><span class="token punctuation">:</span> <span class="token function">calc</span><span class="token punctuation">(</span>60px <span class="token punctuation">(</span>假设值<span class="token punctuation">)</span> + <span class="token function">constant</span><span class="token punctuation">(</span>safe-area-inset-bottom<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token property">height</span><span class="token punctuation">:</span> <span class="token function">calc</span><span class="token punctuation">(</span>60px <span class="token punctuation">(</span>假设值<span class="token punctuation">)</span> + <span class="token function">env</span><span class="token punctuation">(</span>safe-area-inset-bottom<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="_2-苹果微信浏览器滑动，出现网站标识"><a href="#_2-苹果微信浏览器滑动，出现网站标识" aria-hidden="true" class="header-anchor">#</a> 2. 苹果微信浏览器滑动，出现网站标识</h2> <blockquote><p>微信自带浏览器往下拖动会动态查看网页网址，影响网页的用户体验，尤其是苹果小屏手机，滑动列表页时，因为这个默认行为导致滑动不顺畅。<br>
可以在 <em>touchstart touchmove</em> 事件中<strong>阻止默认行为</strong>解决该问题</p></blockquote> <p>网上搜索的一种方法：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * 这种方法的缺点是如果有多个地方滚动，那么就要在这些容器上调用overscroll方法
 */</span>
<span class="token keyword">const</span> <span class="token function-variable function">overscroll</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  el<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'touchstart'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> top <span class="token operator">=</span> el<span class="token punctuation">.</span>scrollTop<span class="token punctuation">,</span>
      totalScroll <span class="token operator">=</span> el<span class="token punctuation">.</span>scrollHeight<span class="token punctuation">,</span>
      currentScroll <span class="token operator">=</span> top <span class="token operator">+</span> el<span class="token punctuation">.</span>offsetHeight
    <span class="token comment">// 顶部下滑</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>top <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      el<span class="token punctuation">.</span>scrollTop <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>currentScroll <span class="token operator">===</span> totalScroll<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 底部赏花</span>
      el<span class="token punctuation">.</span>scrollTop <span class="token operator">=</span> top <span class="token operator">-</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  el<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'touchmove'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">evt</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>offsetHeight <span class="token operator">&lt;</span> el<span class="token punctuation">.</span>scrollHeight<span class="token punctuation">)</span> evt<span class="token punctuation">.</span>_isScroller <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">overscroll</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.scroll'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'touchmove'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">evt</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>evt<span class="token punctuation">.</span>_isScroller<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    evt<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>如果只是单页面某个路由控制这问题，参考以下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// mounted</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>$el<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'touchstart'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleTouchStart<span class="token punctuation">)</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>$el<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'touchmove'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleTouchMove<span class="token punctuation">)</span>

<span class="token comment">// start</span>
<span class="token function">handleTouchStart</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>startY <span class="token operator">=</span> e<span class="token punctuation">.</span>touches<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>pageY
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token comment">// move 中间有个坑，如果在start 和move 事件中阻止冒泡（e.stopPropagation()），那么会导致用了fastclick的dom上监听click事件失效</span>
<span class="token function">handleTouchMove</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> endY <span class="token operator">=</span> e<span class="token punctuation">.</span>changedTouches<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>pageY
    <span class="token keyword">const</span> changedY <span class="token operator">=</span> endY <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>startY
    <span class="token keyword">const</span> scroll_top <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$el<span class="token punctuation">.</span>scrollTop
    <span class="token comment">// 判断是否在顶部，且向下拖动</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>scroll_top <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> changedY <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 判断是否在底部，且向上拖动</span>
    <span class="token keyword">const</span> totalScroll <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$el<span class="token punctuation">.</span>scrollHeight
    <span class="token keyword">const</span> currentScroll <span class="token operator">=</span> scroll_top <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$el<span class="token punctuation">.</span>offsetHeight
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentScroll <span class="token operator">===</span> totalScroll <span class="token operator">&amp;&amp;</span> changedY <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>

<span class="token comment">// unmounted</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>$el<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'touchstart'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleTouchStart<span class="token punctuation">)</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>$el<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'touchmove'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleTouchMove<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h2 id="_3-video-标签在移动端的坑"><a href="#_3-video-标签在移动端的坑" aria-hidden="true" class="header-anchor">#</a> 3. video 标签在移动端的坑</h2> <blockquote><p>需求描述：实现类似于斗鱼客户端中的直播列表页面，滑动到对应的直播位置播放该直播的视频。</p></blockquote> <h3 id="坑-1-自动播放"><a href="#坑-1-自动播放" aria-hidden="true" class="header-anchor">#</a> 坑 1 自动播放</h3> <p>自动播放的需求还是很多的，但是由于消耗用户流量，浏览器和系统的限制了自动播放。即在无交互的情况下调用 play()方法会没有效果。<br>
在 webview，微信浏览器和小米自带的浏览器试了后，至少的一个前提是要静音且有交互。</p> <p>考虑到需求，在监听页面的滚动事件时来控制 video 的播放，播放完毕后调用 paly 播放下一个视频。至此，在公司 app 里的 webview 和小米手机浏览器中可以完成播放功能。但是在微信浏览器（安卓）中并不行，最多只会播放第一个视频，下个视频不会自动播放，一定要与用户交互，第一个坑到此结束</p> <h3 id="坑-2-局域播放"><a href="#坑-2-局域播放" aria-hidden="true" class="header-anchor">#</a> 坑 2 局域播放</h3> <p>直播列表，那就注定视频在列表页不是全屏播放，所以要局域播放。此时需要 <code>playsinline</code> 属性，考虑到兼容性，加上 <code>webkit-playsinline</code> 和 <code>x5-playsinline</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>video
  muted<span class="token operator">=</span><span class="token string">&quot;muted&quot;</span>
  v<span class="token operator">-</span>show<span class="token operator">=</span><span class="token string">&quot;index != loop&quot;</span>
  <span class="token punctuation">:</span>poster<span class="token operator">=</span><span class="token string">&quot;videoPoster&quot;</span>
  x5<span class="token operator">-</span>playsinline<span class="token operator">=</span><span class="token string">&quot;true&quot;</span> <span class="token comment">/*在微信浏览器中小屏播放*/</span>
  x5<span class="token operator">-</span>video<span class="token operator">-</span>orientation<span class="token operator">=</span><span class="token string">&quot;portraint&quot;</span>
  playsinline <span class="token comment">// 小屏播放</span>
  webkit<span class="token operator">-</span>playsinline<span class="token operator">=</span><span class="token string">&quot;true&quot;</span> <span class="token comment">/*ios 10 以下设置区域播放*/</span>
  preload<span class="token operator">=</span><span class="token string">&quot;auto&quot;</span>
  <span class="token punctuation">:</span>src<span class="token operator">=</span><span class="token string">&quot;videoSrc&quot;</span>
  ref<span class="token operator">=</span><span class="token string">&quot;cardVideo&quot;</span>
  @ended<span class="token operator">=</span><span class="token string">&quot;videoEnd&quot;</span>
  @pause<span class="token operator">=</span><span class="token string">&quot;videoPause&quot;</span>
  @playing<span class="token operator">=</span><span class="token string">&quot;videoPlaying&quot;</span>
<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>video<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><code>x5-video-player-type=&quot;h5&quot; /_启用 H5 播放器,是 wechat 安卓版特性_/</code> 注意这个属性，启用这个属性，视频不会在区域内播放，而是开启个全屏播放。</p> <h3 id="_3-video-层级最高"><a href="#_3-video-层级最高" aria-hidden="true" class="header-anchor">#</a> 3 video 层级最高</h3> <p>在安卓中，视频播放后，视频的渲染就被浏览器接管了，此时的 video 标签层级最高。需求是点击视频跳到直播也，但是 video 被浏览器接管后，点击会出现 video 的控制跳，video 的点击事件监听不到，导致该需求在播放视频时实现不了。<br>
后来想到用 canvas 绘制视频，在谷歌浏览器调试时一切正常，但是在安卓中打开会让视频区域黑屏，遂放弃这个方案</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>video<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
  <span class="token string">'play'</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> i <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 此处可改成window.requestAnimationFrame</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>video<span class="token punctuation">.</span>ended <span class="token operator">||</span> video<span class="token punctuation">.</span>pause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">clearInterval</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      ctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">270</span><span class="token punctuation">,</span> <span class="token number">135</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token boolean">false</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="_4-参考文章"><a href="#_4-参考文章" aria-hidden="true" class="header-anchor">#</a> 4 参考文章</h3> <p><a href="https://juejin.im/post/5b189712f265da6e235488c1#heading-13" target="_blank" rel="noopener noreferrer">视频播放--踩坑小计 <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="_4-fastclick-在部分-ios-引起的问题"><a href="#_4-fastclick-在部分-ios-引起的问题" aria-hidden="true" class="header-anchor">#</a> 4 fastclick 在部分 ios 引起的问题</h2> <p>在 ios11 以上的机型上，由于引入了 fastclick 导致点击 input 需要点好几次才能聚焦。由于 ios11 以上已经没有 300ms 的延迟，调用 fastclick 的 focus 方法不会聚焦，修改其原型方法。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token class-name">FastClick</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">focus</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">targetElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> length

  <span class="token comment">// Issue #160: on iOS 7, some input elements (e.g. date datetime month) throw a vague TypeError on setSelectionRange. These elements don't have an integer value for the selectionStart and selectionEnd properties, but unfortunately that can't be used for detection because accessing the properties also throws a TypeError. Just check the type instead. Filed as Apple bug #15122724.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    deviceIsIOS <span class="token operator">&amp;&amp;</span>
    targetElement<span class="token punctuation">.</span>setSelectionRange <span class="token operator">&amp;&amp;</span>
    targetElement<span class="token punctuation">.</span>type<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'date'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
    targetElement<span class="token punctuation">.</span>type <span class="token operator">!==</span> <span class="token string">'time'</span> <span class="token operator">&amp;&amp;</span>
    targetElement<span class="token punctuation">.</span>type <span class="token operator">!==</span> <span class="token string">'month'</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    targetElement<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    length <span class="token operator">=</span> targetElement<span class="token punctuation">.</span>value<span class="token punctuation">.</span>length
    targetElement<span class="token punctuation">.</span><span class="token function">setSelectionRange</span><span class="token punctuation">(</span>length<span class="token punctuation">,</span> length<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    targetElement<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h2 id="_5-浏览器打印"><a href="#_5-浏览器打印" aria-hidden="true" class="header-anchor">#</a> 5 浏览器打印</h2> <p>使用插件<code>react-to-print</code>打印页面</p> <ul><li>坑点 1 边线显示不全</li></ul> <p>使用 div 布局，设置 border 样式，打印样式时，border 显示失真，有的显示不了。使用 table 布局，可以完全显示边线</p> <ul><li>坑点 2 打印多页面，下一页面时顶部空白</li></ul> <p>每一个页面应该有明确的内容，再切换到下一页时，增加样式<code>pageBreakBefore: 'always'</code>。page-break-after 属性可以让我们强制或者避免页面在一个元素之后断页，即在<strong>在一个元素之后断页</strong>，如果我们想要一个元素总是在页面的开头，我们可以强制页面设置<code>page-break-before</code>属性来进行断页。</p></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/hkx930919/book/edit/master/project-book/project.md" target="_blank" rel="noopener noreferrer">编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">最后更新时间: </span> <span class="time">11/23/2019, 6:00:20 PM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/book/project-book/" class="prev router-link-active">
          踩坑
        </a></span> <!----></p></div> </div> <!----></div></div>
    <script src="/book/assets/js/app.983c8796.js" defer></script><script src="/book/assets/js/29.e1cc56d4.js" defer></script>
  </body>
</html>
